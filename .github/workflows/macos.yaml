name: XMUX macOS

on:
  push:
    branches:
      - master
    paths:
      - .github/workflows/macos.yaml
      - lib/**
      - macos/**
      - pubspec.yaml
      - pubspec.lock

jobs:
  Archive:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: subosito/flutter-action@v2
        with:
          channel: beta
      - name: Build App
        run: |
          echo $CONFIG_FILE | base64 -d > lib/config.dart
          echo $GOOGLE_SERVICES_IOS > ./macos/GoogleService-Info.plist
          export FLUTTER_BUILD_NAME=`cat ./lib/config.sample.dart | head -6 | tail -1 | sed -e "s/[A-z:', \-]//g"`
          export FLUTTER_BUILD_NUMBER=`git rev-list HEAD --count`
          flutter build macos \
            --release \
            --build-name=$FLUTTER_BUILD_NAME \
            --build-number=$FLUTTER_BUILD_NUMBER
        env:
          CONFIG_FILE: ${{ secrets.CONFIG_FILE }}
          GOOGLE_SERVICES_IOS: ${{ secrets.GOOGLE_SERVICES_IOS }}
      - uses: actions/upload-artifact@v3
        with:
          name: XMUX-macOS
          path: build/macos/Build/Products/Release/XMUX.app
